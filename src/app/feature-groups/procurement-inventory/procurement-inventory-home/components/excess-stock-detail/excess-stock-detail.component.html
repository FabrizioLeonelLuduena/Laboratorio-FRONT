<div class="flex flex-col gap-4 p-4">
  <!-- Header -->
  <div class="px-2">
    <h1 class="text-2xl font-bold text-[var(--on-surface)]">Exceso de Stock</h1>
  </div>

  <!-- Loading state -->
  @if (isLoading()) {
    <p-card>
      <div class="flex justify-center items-center py-8">
        <i class="pi pi-spin pi-spinner text-2xl text-[var(--primary-color)]"></i>
      </div>
    </p-card>
  }

  <!-- Empty state -->
  @if (!isLoading() && locationAlerts().length === 0) {
    <p-card>
      <div class="flex flex-col items-center justify-center py-8 text-center">
        <i class="pi pi-check-circle text-4xl text-green-500 mb-4"></i>
        <p class="text-lg font-medium text-[var(--on-surface)]">No hay alertas de exceso de stock</p>
        <p class="text-sm text-[var(--on-surface-muted)] mt-2">
          Todos los insumos tienen niveles de stock dentro de los límites establecidos
        </p>
      </div>
    </p-card>
  }

  <!-- Location groups -->
  @if (!isLoading() && locationAlerts().length > 0) {
    <p-card>
      <p-accordion [multiple]="true" [activeIndex]="[0]">
        @for (location of paginatedLocations(); track location.locationId) {
          <p-accordionTab>
            <ng-template pTemplate="header">
              <div class="flex items-center justify-between w-full gap-3">
                <div class="flex items-center gap-3">
                  <i class="pi pi-map-marker text-lg text-[var(--primary-color)]"></i>
                  <div>
                    <h3 class="text-base font-semibold text-[var(--on-surface)]">
                      {{ location.locationName }}
                    </h3>
                    <p class="text-xs text-[var(--on-surface-muted)]">
                      {{ location.alerts.length }} insumos con alertas
                    </p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  @if (location.criticalCount > 0) {
                    <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-50">
                      <span class="block h-2 w-2 rounded-full bg-red-500"></span>
                      <span class="text-xs font-semibold text-red-600">
                        {{ location.criticalCount }} crítico{{ location.criticalCount > 1 ? 's' : '' }}
                      </span>
                    </div>
                  }
                  @if (location.warningCount > 0) {
                    <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-50">
                      <span class="block h-2 w-2 rounded-full bg-yellow-400"></span>
                      <span class="text-xs font-semibold text-yellow-600">
                        {{ location.warningCount }} advertencia{{ location.warningCount > 1 ? 's' : '' }}
                      </span>
                    </div>
                  }
                </div>
              </div>
            </ng-template>

            <div class="overflow-x-auto">
              <table class="w-full text-sm border-collapse">
                <thead>
                  <tr class="bg-[var(--surface-alt)] border-b border-[var(--border-color)]">
                    <th class="px-4 py-3 text-left font-semibold text-[var(--on-surface)]">Insumo</th>
                    <th class="px-4 py-3 text-right font-semibold text-[var(--on-surface)]">Stock actual</th>
                    <th class="px-4 py-3 text-right font-semibold text-[var(--on-surface)]">Stock máximo</th>
                    <th class="px-4 py-3 text-right font-semibold text-[var(--on-surface)]">Exceso</th>
                  </tr>
                </thead>
                <tbody>
                  @for (alert of location.alerts; track alert.supplyId) {
                    <tr class="border-b border-[var(--border-color)] transition-colors duration-200 hover:bg-[var(--surface-hover)] last:border-b-0">
                      <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                          <span
                            class="block h-2.5 w-2.5 rounded-full shrink-0"
                            [ngClass]="getSeverityDotClass(alert.severity)">
                          </span>
                          <span class="text-[var(--on-surface)] font-medium">
                            {{ alert.supplyName }}
                          </span>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-right text-[var(--on-surface)]">
                        {{ alert.currentStock }}
                      </td>
                      <td class="px-4 py-3 text-right text-[var(--on-surface)]">
                        {{ alert.maximumStock }}
                      </td>
                      <td class="px-4 py-3 text-right">
                        <span [class]="getSeverityColor(alert.severity)" class="font-semibold">
                          {{ getExcessPercentage(alert.currentStock, alert.maximumStock) }}
                        </span>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </p-accordionTab>
        }
      </p-accordion>

      @if (locationAlerts().length > pageSize()) {
        <ng-template pTemplate="footer">
          <p-paginator
            [first]="currentPage() * pageSize()"
            [rows]="pageSize()"
            [totalRecords]="locationAlerts().length"
            [rowsPerPageOptions]="[5, 10, 20]"
            (onPageChange)="onPageChange($event)">
          </p-paginator>
        </ng-template>
      }
    </p-card>
  }
</div>
