<p-card class="flex flex-col h-full transition-shadow duration-200">
  <div class="flex items-start justify-between gap-3 pb-3 border-b border-[var(--border-color)] mb-4">
    <div class="flex items-start gap-2 flex-1 min-w-0">
      <i [ngClass]="icon" class="text-base text-[var(--brand-primary)] shrink-0 mt-0.5"></i>
      <div class="min-w-0 flex-1">
        <h3 class="text-base font-semibold text-[var(--on-surface)] m-0 leading-tight overflow-hidden text-ellipsis whitespace-nowrap">
          {{ title }}
        </h3>
        <p *ngIf="description" class="text-xs text-[var(--on-surface-muted)] mt-0.5 mb-0 leading-snug overflow-hidden text-ellipsis whitespace-nowrap">
          {{ description }}
        </p>
      </div>
    </div>
    <p-button *ngIf="helpText"
      icon="pi pi-question-circle"
      [text]="true"
      [rounded]="true"
      [outlined]="true"
      size="small"
      class="w-7 h-7 min-w-7 self-start"
      (onClick)="openInfo()">
    </p-button>
  </div>

  <div class="flex-1 border border-[var(--border-color)] rounded-lg bg-[var(--surface-card)] overflow-hidden h-full">
    <div class="h-full min-h-[320px]">
      @if ((chartType === 'pie' || chartType === 'doughnut') && referenceValues && referenceValues.length > 0) {
        <!-- Layout con grÃ¡fico y valores de referencia -->
        <div class="w-full h-full flex flex-row items-center justify-center gap-6 px-4 py-2">
          <div class="flex-1 flex items-center justify-center max-w-[50%]">
            <div class="w-full max-w-[280px] aspect-square flex items-center justify-center">
              <p-chart [type]="chartType" [data]="data" [options]="resolvedOptions" class="w-full h-full"></p-chart>
            </div>
          </div>
          <div class="flex flex-col gap-3 flex-1 max-w-[200px] justify-center">
            @for (ref of referenceValues; track $index) {
              <div class="flex items-center gap-2">
                @if (ref.color) {
                  <div class="w-3 h-3 rounded-full shrink-0" [style.background-color]="ref.color"></div>
                }
                <div class="flex-1 min-w-0">
                  <div class="text-xs font-medium text-[var(--on-surface)] truncate">{{ ref.label }}</div>
                  <div class="text-xs font-semibold text-[var(--brand-primary)]">{{ ref.value }} ({{ ref.percentage }})</div>
                </div>
              </div>
            }
          </div>
        </div>
      } @else {
        <!-- Layout original sin valores de referencia -->
        <div class="w-full h-full flex py-2 justify-center">
          <div [style.width]="chartType === 'pie' || chartType === 'doughnut' ? '60%' : '100%'" [style.height]="chartType === 'pie' || chartType === 'doughnut' ? '60%' : '100%'" class="flex items-center justify-center">
            <p-chart [type]="chartType" [data]="data" [options]="resolvedOptions" class="w-full h-full"></p-chart>
          </div>
        </div>
      }
    </div>
  </div>

  <p *ngIf="footer" class="text-xs text-[var(--on-surface-muted)] mt-3 mb-0">
    {{ footer }}
  </p>
</p-card>

<app-generic-modal-form
  [visible]="infoVisible"
  [title]="title"
  [width]="'520px'"
  (closed)="closeInfo()">
  <div class="p-4 text-sm text-[var(--on-surface)]">
    <p class="m-0">{{ helpText }}</p>
  </div>
</app-generic-modal-form>
